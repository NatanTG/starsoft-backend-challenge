<h1 align="center">
    üõí E-commerce Order Management API
</h1>

<p align="center">
Sistema completo de gerenciamento de pedidos para e-commerce com arquitetura orientada a eventos (Kafka) e busca avan√ßada (Elasticsearch).
<br/>
Desenvolvido como desafio t√©cnico demonstrando arquitetura modular NestJS, DDD, e integra√ß√£o com servi√ßos externos.
<br/>
<br/>
<strong>üöÄ Novo aqui? Acesse o <a href="/docs/ONBOARDING.md">Onboarding Completo</a></strong>
</p>

<p align="center">
  <img alt="Made with Love" src="https://img.shields.io/badge/MADE_WITH-LOVE-032F5B?style=for-the-badge" />
  <img alt="Node.js" src="https://img.shields.io/badge/NODE.JS-20+-339933?style=for-the-badge&logo=node.js&logoColor=white" />
  <img alt="NestJS" src="https://img.shields.io/badge/NESTJS-11+-E0234E?style=for-the-badge&logo=nestjs&logoColor=white" />
  <img alt="Docker" src="https://img.shields.io/badge/DOCKER-READY-2496ED?style=for-the-badge&logo=docker&logoColor=white" />
</p>

## üöÄ Quick Start

### Requisitos

- **Node.js** 20+
- **pnpm** 10.7.0+
- **Docker** & **Docker Compose**

### üê≥ Iniciar o projeto (Recomendado)

```bash
# Clone o reposit√≥rio
git clone <repo-url>
cd starsoft-backend-challenge

# Copie as vari√°veis de ambiente
cp .env.example .env

# Execute todo o projeto com Docker
docker compose up
```

**Aguarde todos os containers ficarem prontos e acesse:**
- **üåê API**: http://localhost:3000
- **üìö Documenta√ß√£o Swagger**: http://localhost:3000/api
- **üìä Grafana**: http://localhost:3001 (admin/admin)
- **üîç Prometheus**: http://localhost:9090
- **‚ö° Elasticsearch**: http://localhost:9200

## üîß Vari√°veis de Ambiente

| Vari√°vel                          | Descri√ß√£o                                     | Valor Padr√£o                                    |
| --------------------------------- | --------------------------------------------- | ----------------------------------------------- |
| **DATABASE_URL**                  | URL de conex√£o com PostgreSQL                | postgresql://ecommerce:ecommerce123@localhost:5432/ecommercedb |
| **POSTGRES_USER**                 | Usu√°rio do banco PostgreSQL                  | ecommerce                                       |
| **POSTGRES_PASSWORD**             | Senha do banco PostgreSQL                    | ecommerce123                                    |
| **POSTGRES_DB**                   | Nome do banco de dados                       | ecommercedb                                     |
| **PORT**                          | Porta da aplica√ß√£o                            | 3000                                            |
| **NODE_ENV**                      | Ambiente de execu√ß√£o                          | development                                     |
| **JWT_SECRET**                    | Chave secreta para JWT                       | your-super-secret-jwt-key-here                  |
| **DASHBOARD_URL**                 | URL do dashboard frontend                     | http://localhost:5173                           |
| **CORS_ORIGINS**                  | URLs permitidas para CORS                    | http://localhost:3000,http://localhost:3001     |
| **KAFKA_BROKERS**                 | Endere√ßos dos brokers Kafka                  | localhost:9092                                  |
| **KAFKA_CLIENT_ID**               | ID do cliente Kafka                          | ecommerce-api                                   |
| **KAFKA_MOCK_MODE**               | Ativa modo mock para Kafka                   | false                                           |
| **ELASTICSEARCH_NODE**            | URL do servidor Elasticsearch                | http://localhost:9200                           |
| **RESEND_KEY**                    | Chave da API Resend para emails              | your-resend-api-key-here                        |
| **MAIL_FROM_ADDRESS**             | Email remetente                               | ecommerce@yourdomain.com                        |
| **GRAFANA_ADMIN_USER**            | Usu√°rio admin do Grafana                     | admin                                           |
| **GRAFANA_ADMIN_PASSWORD**        | Senha admin do Grafana                       | your-secure-grafana-password                    |
| **DB_LOGGING**                    | Habilita logs do banco de dados              | true                                            |
| **DB_SYNCHRONIZE**                | Sincroniza√ß√£o autom√°tica do schema           | true                                            |
| **HELMET_HSTS_ENABLED**           | Habilita HSTS no Helmet                      | false                                           |

## üõ†Ô∏è Comandos

### Desenvolvimento
- **pnpm dev**: Executa o servidor em modo desenvolvimento com hot reload
- **pnpm debug**: Executa em modo debug com breakpoints
- **pnpm start**: Executa o servidor b√°sico
- **pnpm start:prod**: Executa em modo produ√ß√£o

### Build e Deploy
- **pnpm build**: Gera build de produ√ß√£o
- **pnpm format**: Formata o c√≥digo automaticamente
- **pnpm lint**: Executa linting e corre√ß√µes autom√°ticas

### Docker
- **pnpm run docker:up**: Sobe toda a infraestrutura
- **pnpm run docker:down**: Para todos os containers
- **pnpm run docker:logs**: Visualiza logs dos containers
- **pnpm run docker:build**: Faz build da imagem Docker

### Banco de Dados
- **pnpm run typeorm:run**: Executa migrations
- **pnpm run typeorm:generate**: Gera nova migration
- **pnpm run typeorm:revert**: Reverte √∫ltima migration

### Testes
- **pnpm test**: Executa todos os testes
- **pnpm run test:cov**: Testes com coverage
- **pnpm run test:watch**: Testes em modo watch

## üéØ Contexto do Teste T√©cnico

Este projeto foi desenvolvido como resposta ao **Teste para Desenvolvedor Back-End Node.js/Nest.js** da **Starsoft**, implementando todos os requisitos solicitados:

### Requisitos Implementados ‚úÖ

- ‚úÖ **API RESTful** completa para gerenciamento de pedidos (CRUD)
- ‚úÖ **Arquitetura modular NestJS** com tr√™s camadas (Controllers, Services, Repositories)
- ‚úÖ **Domain-Driven Design** com organiza√ß√£o por m√≥dulos de dom√≠nio
- ‚úÖ **PostgreSQL + TypeORM** com migrations autom√°ticas
- ‚úÖ **Comunica√ß√£o via Kafka** com eventos `order.created` e `order.updated`
- ‚úÖ **Elasticsearch** para indexa√ß√£o e busca avan√ßada de pedidos
- ‚úÖ **Docker & Docker Compose** para orquestra√ß√£o completa
- ‚úÖ **Testes unit√°rios** com Jest e cobertura de c√≥digo
- ‚úÖ **Swagger/OpenAPI** para documenta√ß√£o da API
- ‚úÖ **Logs estruturados** com interceptadores NestJS
- ‚úÖ **Monitoramento avan√ßado** com Prometheus + Grafana (diferencial)

### üé® Funcionalidades Principais

- **CRUD completo de pedidos** com relacionamentos complexos
- **Arquitetura orientada a eventos** com Apache Kafka
- **Busca avan√ßada** com Elasticsearch e filtros din√¢micos
- **Monitoramento completo** com Prometheus + Grafana
- **Autentica√ß√£o JWT** com reset de senha
- **Arquitetura Modular NestJS + DDD** com separa√ß√£o clara de responsabilidades
- **Observabilidade** com logs estruturados e m√©tricas

### üîß Instala√ß√£o Detalhada (Desenvolvimento)

Se preferir instalar e executar em modo desenvolvimento:

```bash
# Instalar depend√™ncias
pnpm install

# Subir infraestrutura
pnpm run docker:up

# Executar migrations
pnpm run typeorm:run

# Iniciar em modo desenvolvimento
pnpm dev
```

## üìö Documenta√ß√£o

- **[üöÄ Onboarding Completo](/docs/ONBOARDING.md)** - Guia do desenvolvedor para come√ßar rapidamente
- **[üèóÔ∏è Arquitetura & Infraestrutura](/docs/ARCHITECTURE.md)** - Padr√µes, tecnologias e estrutura do projeto
- **[üß™ Guia de Testes Postman](/docs/POSTMAN-GUIDE.md)** - Jornada completa para testar toda a API
- **[üì° Refer√™ncia da API](/docs/API-REFERENCE.md)** - Documenta√ß√£o detalhada de todos os endpoints

---

## üß™ Estrat√©gia de Desenvolvimento e Mock

### üí° Por que Mock?

Como este √© um **projeto de teste t√©cnico** e n√£o possui servi√ßos externos reais conectados (Kafka clusters, Elasticsearch em produ√ß√£o), implementei uma **estrat√©gia inteligente de mock** que permite:

1. **Demonstrar a arquitetura completa** sem necessidade de infraestrutura complexa
2. **Simular cen√°rios reais** com dados mockados consistentes  
3. **Facilitar testes e desenvolvimento** local
4. **Manter compatibilidade** com implementa√ß√£o real quando necess√°rio

### üîß Como Funciona o Mock

#### **Kafka Mock Strategy**
```env
# No .env ou ambiente
KAFKA_MOCK_MODE=true  # Ativa modo mock
KAFKA_MOCK_MODE=false # Usa Kafka real
```

**Quando `KAFKA_MOCK_MODE=true`:**
- ‚úÖ Simula publica√ß√£o de eventos com logs detalhados
- ‚úÖ Mostra exatamente o payload que seria enviado ao Kafka
- ‚úÖ Registra t√≥picos, timestamps e dados completos
- ‚úÖ N√£o requer conex√£o real com Kafka

**Exemplo de log no modo mock:**
```
[MOCK] Message would be published to topic: order.created
{
  "messageId": "order-123",
  "messageType": "order.created", 
  "timestamp": "2025-08-14T12:34:56.789Z",
  "payload": {
    "id": "order-123",
    "userId": "user-456",
    "status": "PENDING",
    "totalAmount": 1200.00,
    "items": [...]
  }
}
```

#### **Elasticsearch Mock Strategy**

- **MockElasticsearchService** retorna dados simulados realistas
- **SearchOrders** retorna resultados mockados com pagina√ß√£o
- **Opera√ß√µes de indexa√ß√£o** s√£o simuladas com sucesso
- **Logs confirmam** todas as opera√ß√µes mockadas

**Exemplo de resposta mockada:**
```json
{
  "data": [
    {
      "id": "order-1",
      "userId": "user-123", 
      "status": "pending",
      "totalAmount": 199.99,
      "items": [],
      "createdAt": "2025-08-14T12:34:56.789Z"
    }
  ],
  "total": 1,
  "page": 1,
  "totalPages": 1
}
```

### üîÑ Alternando Entre Mock e Real

Para usar os servi√ßos reais (em produ√ß√£o):

```env
# .env
KAFKA_MOCK_MODE=false
ELASTICSEARCH_NODE=http://your-real-elasticsearch:9200
KAFKA_BROKERS=your-kafka-cluster:9092
```

A arquitetura foi desenvolvida para suportar **ambos os modos** sem altera√ß√£o de c√≥digo!

---

## üèóÔ∏è Arquitetura

### Padr√µes Implementados

- **Three-Layer Architecture**: Separa√ß√£o clara entre Controllers, Services e Repositories
- **Modular Architecture**: Organiza√ß√£o por m√≥dulos de dom√≠nio (padr√£o NestJS)
- **Domain-Driven Design (DDD)**: Estrutura baseada em dom√≠nios de neg√≥cio
- **Repository Pattern**: Abstra√ß√£o de acesso a dados
- **Event-Driven Architecture**: Comunica√ß√£o ass√≠ncrona via Kafka
- **Dependency Injection**: Invers√£o de controle via NestJS

### Estrutura do Projeto

```
src/
‚îú‚îÄ‚îÄ core/                    # üîß Configura√ß√µes centrais e infraestrutura
‚îÇ   ‚îú‚îÄ‚îÄ config/             # Configura√ß√µes (Kafka, Elasticsearch, Swagger, TypeORM)
‚îÇ   ‚îú‚îÄ‚îÄ database/           # M√≥dulo do banco de dados
‚îÇ   ‚îú‚îÄ‚îÄ env.ts              # Valida√ß√£o de vari√°veis de ambiente
‚îÇ   ‚îî‚îÄ‚îÄ migrations/         # Migra√ß√µes do banco de dados
‚îÇ
‚îú‚îÄ‚îÄ modules/                # üè¢ M√≥dulos de dom√≠nio (Business Logic)
‚îÇ   ‚îú‚îÄ‚îÄ auth/              # üîê Autentica√ß√£o e autoriza√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/        # Entidades e regras de neg√≥cio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ application/   # Services e DTOs (camada de aplica√ß√£o)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/# Repositories e adaptadores (camada de dados)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ presentation/  # Controllers e rotas (camada de apresenta√ß√£o)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ orders/            # üì¶ Dom√≠nio de pedidos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/        # Entidades (Order, OrderItem) e enums
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ application/   # Services (CRUD operations) e DTOs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/# Order Repository implementa√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ presentation/  # Controllers para API REST
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ user/              # üë§ Dom√≠nio de usu√°rios
‚îÇ       ‚îú‚îÄ‚îÄ domain/        # User entity
‚îÇ       ‚îú‚îÄ‚îÄ application/   # User services e DTOs
‚îÇ       ‚îú‚îÄ‚îÄ infrastructure/# User repository
‚îÇ       ‚îî‚îÄ‚îÄ presentation/  # User controllers
‚îÇ
‚îî‚îÄ‚îÄ shared/                # üîó C√≥digo compartilhado entre m√≥dulos
    ‚îú‚îÄ‚îÄ controllers/       # Controllers compartilhados (m√©tricas)
    ‚îú‚îÄ‚îÄ dtos/             # DTOs compartilhados e de eventos
    ‚îú‚îÄ‚îÄ guards/           # Guards de autentica√ß√£o
    ‚îú‚îÄ‚îÄ interceptors/     # Interceptadores (logging)
    ‚îú‚îÄ‚îÄ services/         # Servi√ßos compartilhados
    ‚îÇ   ‚îú‚îÄ‚îÄ crypt/        # Servi√ßo de criptografia (bcrypt)
    ‚îÇ   ‚îú‚îÄ‚îÄ elasticsearch/# Servi√ßo de busca
    ‚îÇ   ‚îú‚îÄ‚îÄ jwt/          # Servi√ßo de JWT
    ‚îÇ   ‚îú‚îÄ‚îÄ kafka/        # Servi√ßo de mensageria
    ‚îÇ   ‚îú‚îÄ‚îÄ logger/       # Logger estruturado
    ‚îÇ   ‚îú‚îÄ‚îÄ mail/         # Servi√ßo de email (Resend)
    ‚îÇ   ‚îî‚îÄ‚îÄ metrics/      # M√©tricas (Prometheus)
    ‚îî‚îÄ‚îÄ types/            # Tipos TypeScript compartilhados
```

### Infraestrutura (Docker Compose)

```yaml
Servi√ßos configurados:
‚îú‚îÄ‚îÄ api (NestJS)           # Aplica√ß√£o principal na porta 3000
‚îú‚îÄ‚îÄ postgres               # Banco de dados principal na porta 5432
‚îú‚îÄ‚îÄ kafka + zookeeper      # Message broker nas portas 9092/2181
‚îú‚îÄ‚îÄ elasticsearch          # Search engine na porta 9200
‚îú‚îÄ‚îÄ prometheus             # M√©tricas na porta 9090
‚îî‚îÄ‚îÄ grafana               # Dashboards na porta 3001
```

---

## üîå Servi√ßos & Integra√ß√µes

### 1. PostgreSQL (Banco Principal)
- **Vers√£o**: 15-alpine | **Porta**: 5432
- **Status**: ‚úÖ **Totalmente funcional** - conex√£o real
- **Funcionalidades**: Armazenamento de orders, users e order_items com relacionamentos

### 2. Apache Kafka (Mensageria)
- **Vers√£o**: Bitnami Kafka 3.5 + Zookeeper 3.9 | **Portas**: 9092, 2181
- **Status**: üé≠ **Mockado para desenvolvimento** (configur√°vel)
- **Eventos**: `order.created`, `order.updated`, `user.created`
- **Features**: Auto-retry, logs detalhados, modo mock/real altern√°vel

### 3. Elasticsearch (Search Engine)
- **Vers√£o**: 8.11.0 | **Porta**: 9200
- **Status**: üé≠ **Mockado com dados realistas** 
- **Funcionalidades**: Busca fuzzy, filtros avan√ßados, aggregations simuladas

### 4. Prometheus + Grafana (Monitoramento)
- **Prometheus**: v2.45.0 na porta 9090
- **Grafana**: 10.0.0 na porta 3001 (admin/admin)
- **Status**: ‚úÖ **Totalmente funcional** - m√©tricas reais
- **M√©tricas**: HTTP requests, m√©tricas de neg√≥cio, performance, health checks

### 5. Servi√ßos Externos
- **Resend** (Email): üé≠ Mockado - Templates para reset de senha e notifica√ß√µes
- **AWS S3** (Storage): üé≠ Mockado - Upload de arquivos e presigned URLs

---

## üì° API Documentation

### Endpoints Principais

#### üîê Autentica√ß√£o
```http
POST /auth/session          # Login
POST /auth/refresh-token    # Renovar token
POST /auth/forgot-password  # Solicitar reset de senha
POST /auth/reset-password   # Reset de senha
```

#### üë§ Usu√°rios
```http
POST /users                 # Criar usu√°rio
```

#### üì¶ Pedidos
```http
POST /orders                # Criar pedido
GET /orders                 # Listar todos os pedidos
GET /orders/search          # Busca avan√ßada (Elasticsearch)
GET /orders/user/:userId    # Pedidos por usu√°rio
GET /orders/:id             # Buscar pedido espec√≠fico
PATCH /orders/:id           # Atualizar pedido
DELETE /orders/:id          # Deletar pedido
```

#### üìä Monitoramento
```http
GET /metrics                # M√©tricas Prometheus
```

### Busca Avan√ßada (Elasticsearch)

```http
GET /orders/search?status=PENDING&dateFrom=2023-01-01&productName=iPhone
```

**Par√¢metros dispon√≠veis:**
- `orderId`: ID espec√≠fico do pedido
- `status`: Status do pedido (`PENDING`, `PROCESSING`, `SHIPPED`, `DELIVERED`, `CANCELLED`)
- `userId`: ID do usu√°rio
- `dateFrom`/`dateTo`: Intervalo de datas
- `productName`: Busca fuzzy nos nomes dos produtos
- `page`/`limit`: Pagina√ß√£o

**Acesse a documenta√ß√£o completa em**: http://localhost:3000/api

---

## üß™ Testes

### Status Atual de Cobertura
- **Statements**: 51.16% (569/1112)
- **Branches**: 32.33% (43/133)
- **Functions**: 41.31% (69/167)
- **Lines**: 51.42% (506/984)

### Scripts de Teste

```bash
# Executar todos os testes
pnpm test

# Testes com coverage
pnpm run test:cov

# Testes em modo watch
pnpm run test:watch

# Testes com an√°lise de mem√≥ria
pnpm run test:memory
```

### Estrat√©gias de Teste
- **Testes unit√°rios** com Jest e mocks robustos
- **Dados mockados 100%** para simula√ß√£o realista de servi√ßos externos
- **35 arquivos** `.spec.ts` com cobertura de servi√ßos principais
- **Mocks inteligentes** que simulam comportamentos reais dos servi√ßos

---

## üìä Monitoramento

### M√©tricas Dispon√≠veis (Prometheus)

#### HTTP Metrics
- **http_requests_total**: Total de requisi√ß√µes HTTP
- **http_request_duration_seconds**: Dura√ß√£o das requisi√ß√µes

#### Business Metrics  
- **orders_total**: Total de pedidos por status e a√ß√£o
- **kafka_messages_total**: Mensagens Kafka por t√≥pico e status
- **elasticsearch_operations_total**: Opera√ß√µes Elasticsearch

#### System Metrics
- **active_connections**: Conex√µes ativas
- M√©tricas padr√£o do Node.js (heap, CPU, etc.)

### Dashboards Grafana
- **Performance da API**: Lat√™ncia, throughput, status codes
- **M√©tricas de Neg√≥cio**: Pedidos por status, eventos Kafka
- **Health Checks**: Status dos servi√ßos externos

**Acesse**: http://localhost:3001 (admin/admin)

---



## üöÄ Tecnologias Utilizadas

### Core
- **Node.js** + **NestJS** + **TypeScript**
- **PostgreSQL** + **TypeORM**
- **Apache Kafka** (Bitnami)
- **Elasticsearch**

### Monitoramento & Observabilidade
- **Prometheus** + **Grafana**
- **Swagger/OpenAPI**
- **Logs estruturados** (JSON)

### Integra√ß√µes
- **Resend** (Email Service)
- **AWS S3** (File Storage)
- **JWT** (Authentication)
- **bcrypt** (Password Hashing)

### Desenvolvimento
- **Jest** + **Supertest** (Testes)
- **ESLint** + **Prettier** (Code Quality)
- **Docker** + **Docker Compose**
- **pnpm** (Package Manager)

---

## üìã Bibliotecas e Depend√™ncias

<details>
<summary>Ver lista completa de depend√™ncias</summary>

### Framework e Core
- **@nestjs/core** ^11.0.1 - Framework principal
- **@nestjs/common** ^11.0.1 - M√≥dulos comuns do NestJS
- **@nestjs/platform-express** ^11.0.1 - Plataforma Express
- **typescript** ^5.7.3 - Linguagem principal
- **reflect-metadata** ^0.2.2 - Metadados para decorators

### Banco de Dados
- **@nestjs/typeorm** ^11.0.0 - Integra√ß√£o TypeORM
- **typeorm** ^0.3.25 - ORM principal
- **pg** ^8.16.3 - Driver PostgreSQL

### Autentica√ß√£o e Seguran√ßa
- **jsonwebtoken** ^9.0.2 - JWT tokens
- **bcrypt** ^6.0.0 - Hash de senhas
- **helmet** ^8.1.0 - Seguran√ßa HTTP
- **@nestjs/throttler** ^6.4.0 - Rate limiting

### Valida√ß√£o e Transforma√ß√£o
- **class-validator** ^0.14.2 - Valida√ß√£o de DTOs
- **class-transformer** ^0.5.1 - Transforma√ß√£o de objetos

### Mensageria e Busca
- **kafkajs** ^2.2.4 - Cliente Kafka
- **@elastic/elasticsearch** ^8.11.0 - Cliente Elasticsearch

### Monitoramento e Observabilidade
- **prom-client** ^15.1.3 - M√©tricas Prometheus
- **@nestjs/swagger** ^11.2.0 - Documenta√ß√£o OpenAPI

### Servi√ßos Externos
- **resend** ^4.6.0 - Servi√ßo de email
- **@aws-sdk/client-s3** ^3.846.0 - AWS S3 client
- **multer** ^2.0.2 - Upload de arquivos

### Desenvolvimento e Testes
- **jest** ^30.0.5 - Framework de testes
- **@nestjs/testing** ^11.0.1 - Utilit√°rios de teste
- **supertest** ^7.0.0 - Testes de API
- **@faker-js/faker** ^9.9.0 - Dados fake para testes

</details>

---

**Desenvolvido para o desafio t√©cnico Starsoft** ‚≠ê

### üéØ Considera√ß√µes Finais

Este projeto demonstra uma implementa√ß√£o robusta que atende a todos os requisitos do teste t√©cnico, com a intelig√™ncia adicional de funcionar tanto com **servi√ßos mockados** (ideal para demonstra√ß√£o e desenvolvimento) quanto com **servi√ßos reais** (produ√ß√£o), simplesmente alternando configura√ß√µes de ambiente.

A arquitetura modular e os padr√µes implementados garantem **escalabilidade**, **manutenibilidade** e **testabilidade** do c√≥digo, seguindo as melhores pr√°ticas do ecossistema Node.js/NestJS.